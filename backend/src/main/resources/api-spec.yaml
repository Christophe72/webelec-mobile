openapi: 3.0.3
info:
  title: WebElec Backend API
  version: 1.0.0
  description: |
    API REST du SaaS WebElec pour électriciens belges.
    
    ## Authentification
    Tous les endpoints (sauf `/api/auth/*`) nécessitent un token JWT dans le header :
    ```
    Authorization: Bearer <token>
    ```
    
    ## Codes de réponse
    - `200` : Succès
    - `201` : Créé
    - `204` : Supprimé (pas de contenu)
    - `400` : Requête invalide (validation)
    - `401` : Non authentifié (token absent ou expiré)
    - `403` : Accès refusé (rôle insuffisant)
    - `404` : Ressource non trouvée
    - `409` : Conflit (email déjà utilisé, etc.)

servers:
  - url: http://localhost:8080
    description: Serveur de développement

tags:
  - name: Auth
    description: Authentification et gestion des tokens
  - name: Societes
    description: Gestion des sociétés (multi-tenant)
  - name: Clients
    description: Gestion des clients
  - name: Chantiers
    description: Gestion des chantiers
  - name: Produits
    description: Gestion des produits
  - name: Interventions
    description: Gestion des interventions
  - name: Devis
    description: Gestion des devis
  - name: Factures
    description: Gestion des factures

paths:
  /api/societes:
    get:
      summary: Lister les sociétés
      description: |
        Retourne la liste des sociétés accessibles à l'utilisateur.
        - **ADMIN** : voit toutes les sociétés
        - **GERANT/TECHNICIEN** : voit uniquement les sociétés auxquelles il appartient
      tags: [Societes]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des sociétés
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SocieteResponse'
              example:
                - id: 1
                  nom: "WebElec SPRL"
                  tva: "BE0123456789"
                  email: "contact@webelec.be"
                  telephone: "+32 2 123 45 67"
                  adresse: "Rue de l'Électricité 42, 1000 Bruxelles"
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      summary: Créer une société
      description: |
        Crée une nouvelle société.
        
        **Rôle requis** : `ADMIN` uniquement
        
        **Règles de validation** :
        - `nom` : obligatoire, max 255 caractères
        - `tva` : obligatoire, max 32 caractères
        - `email` : optionnel, doit être un email valide et unique
        - `telephone` : optionnel, format belge accepté (6-30 caractères, chiffres et +()-./\s)
        - `adresse` : optionnel, max 512 caractères
      tags: [Societes]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SocieteRequest'
            examples:
              valide:
                summary: Exemple valide
                value:
                  nom: "WebElec SPRL"
                  tva: "BE0123456789"
                  email: "contact@webelec.be"
                  telephone: "+32 2 123 45 67"
                  adresse: "Rue de l'Électricité 42, 1000 Bruxelles"
              minimum:
                summary: Exemple minimal (champs obligatoires uniquement)
                value:
                  nom: "Ma Société"
                  tva: "BE9876543210"
              invalide:
                summary: Exemple invalide (nom vide)
                value:
                  nom: ""
                  tva: "BE0123456789"
      responses:
        '200':
          description: Société créée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SocieteResponse'
        '400':
          description: Requête invalide (validation échouée)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              example:
                timestamp: "2025-12-27T10:00:00Z"
                status: 400
                error: "Bad Request"
                message: "Requête invalide"
                details:
                  - "nom: Le nom de la société est obligatoire"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: Conflit (email déjà utilisé)
          content:
            application/json:
              schema:
                type: string
              example: "Email déjà utilisé"
  /api/societes/{id}:
    get:
      summary: Récupérer une société
      description: |
        Récupère les détails d'une société par son ID.
        
        **Rôle requis** : 
        - `ADMIN` : peut voir toutes les sociétés
        - Autres rôles : doit appartenir à la société
      tags: [Societes]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Société trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SocieteResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Mettre à jour une société
      description: |
        Met à jour les informations d'une société existante.
        
        **Rôle requis** : `ADMIN` ou `GERANT` de la société
        
        **Règles** : mêmes validations que POST
      tags: [Societes]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SocieteRequest'
      responses:
        '200':
          description: Société mise à jour
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SocieteResponse'
        '400':
          description: Requête invalide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Conflit (email déjà utilisé par une autre société)
          content:
            application/json:
              schema:
                type: string
    delete:
      summary: Supprimer une société
      description: |
        Supprime une société.
        
        **Rôle requis** : `ADMIN` uniquement
        
        **Attention** : cette opération est irréversible.
      tags: [Societes]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Société supprimée
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  /api/chantiers:
    get:
      summary: List chantiers
      tags: [Chantiers]
      responses:
        '200':
          description: List
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChantierResponse'
    post:
      summary: Create chantier
      tags: [Chantiers]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChantierRequest'
      responses:
        '200':
          description: Created chantier
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChantierResponse'
  /api/chantiers/{id}:
    get:
      summary: Get chantier
      tags: [Chantiers]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Found chantier
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChantierResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Update chantier
      tags: [Chantiers]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChantierRequest'
      responses:
        '200':
          description: Updated chantier
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChantierResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Delete chantier
      tags: [Chantiers]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Deleted
        '404':
          $ref: '#/components/responses/NotFound'
  /api/clients:
    get:
      summary: List clients
      tags: [Clients]
      responses:
        '200':
          description: List
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ClientResponse'
    post:
      summary: Create client
      tags: [Clients]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientRequest'
      responses:
        '200':
          description: Created client
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientResponse'
  /api/clients/{id}:
    get:
      summary: Get client
      tags: [Clients]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Found client
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Update client
      tags: [Clients]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientRequest'
      responses:
        '200':
          description: Updated client
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Delete client
      tags: [Clients]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Deleted
        '404':
          $ref: '#/components/responses/NotFound'
  /api/produits:
    get:
      summary: List produits
      tags: [Produits]
      responses:
        '200':
          description: List
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProduitResponse'
    post:
      summary: Create produit
      tags: [Produits]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProduitRequest'
      responses:
        '200':
          description: Created produit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProduitResponse'
  /api/produits/{id}:
    get:
      summary: Get produit
      tags: [Produits]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Found produit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProduitResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Update produit
      tags: [Produits]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProduitRequest'
      responses:
        '200':
          description: Updated produit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProduitResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Delete produit
      tags: [Produits]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Deleted
        '404':
          $ref: '#/components/responses/NotFound'
  /api/interventions:
    get:
      summary: List interventions
      tags: [Interventions]
      responses:
        '200':
          description: List
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/InterventionResponse'
    post:
      summary: Create intervention
      tags: [Interventions]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InterventionRequest'
      responses:
        '200':
          description: Created intervention
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InterventionResponse'
  /api/interventions/{id}:
    get:
      summary: Get intervention
      tags: [Interventions]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Found intervention
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InterventionResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Update intervention
      tags: [Interventions]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InterventionRequest'
      responses:
        '200':
          description: Updated intervention
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InterventionResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Delete intervention
      tags: [Interventions]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Deleted
        '404':
          $ref: '#/components/responses/NotFound'
  /api/produits-avances:
    get:
      summary: List advanced products
      tags: [ProduitsAvances]
      responses:
        '200':
          description: List
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProduitAvanceResponse'
    post:
      summary: Create advanced product
      tags: [ProduitsAvances]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProduitAvanceRequest'
      responses:
        '200':
          description: Created advanced product
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProduitAvanceResponse'
  /api/produits-avances/{id}:
    get:
      summary: Get advanced product
      tags: [ProduitsAvances]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProduitAvanceResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Update advanced product
      tags: [ProduitsAvances]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProduitAvanceRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProduitAvanceResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Delete advanced product
      tags: [ProduitsAvances]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Deleted
        '404':
          $ref: '#/components/responses/NotFound'
  /api/devis:
    get:
      summary: List devis
      tags: [Devis]
      responses:
        '200':
          description: List
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DevisResponse'
    post:
      summary: Create devis
      tags: [Devis]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DevisRequest'
      responses:
        '200':
          description: Created devis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DevisResponse'
  /api/devis/{id}:
    get:
      summary: Get devis
      tags: [Devis]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Found devis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DevisResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Update devis
      tags: [Devis]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DevisRequest'
      responses:
        '200':
          description: Updated devis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DevisResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Delete devis
      tags: [Devis]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Deleted
        '404':
          $ref: '#/components/responses/NotFound'
  /api/factures:
    get:
      summary: List factures
      tags: [Factures]
      responses:
        '200':
          description: List
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FactureResponse'
    post:
      summary: Create facture
      tags: [Factures]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FactureRequest'
      responses:
        '200':
          description: Created facture
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactureResponse'
  /api/factures/{id}:
    get:
      summary: Get facture
      tags: [Factures]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Found facture
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactureResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Update facture
      tags: [Factures]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FactureRequest'
      responses:
        '200':
          description: Updated facture
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactureResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Delete facture
      tags: [Factures]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Deleted
        '404':
          $ref: '#/components/responses/NotFound'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtenu via /api/auth/login
  parameters:
    IdParam:
      in: path
      name: id
      required: true
      schema:
        type: integer
        format: int64
      description: Identifiant unique de la ressource
  responses:
    NotFound:
      description: Ressource non trouvée
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            timestamp: "2025-12-27T10:00:00Z"
            status: 404
            error: "Not Found"
            message: "Societe non trouvée"
            details: []
    Unauthorized:
      description: Non authentifié (token absent ou expiré)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            timestamp: "2025-12-27T10:00:00Z"
            status: 401
            error: "Unauthorized"
            message: "Token JWT invalide ou expiré"
            details: []
    Forbidden:
      description: Accès refusé (rôle insuffisant)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            timestamp: "2025-12-27T10:00:00Z"
            status: 403
            error: "Forbidden"
            message: "Accès refusé : vous n'avez pas les droits nécessaires"
            details: []
  schemas:
    ApiError:
      type: object
      description: Format standard des erreurs API
      properties:
        timestamp:
          type: string
          format: date-time
          description: Date et heure de l'erreur
        status:
          type: integer
          description: Code HTTP
        error:
          type: string
          description: Nom de l'erreur HTTP
        message:
          type: string
          description: Message d'erreur lisible
        details:
          type: array
          items:
            type: string
          description: Détails supplémentaires (erreurs de validation)
    SocieteRequest:
      type: object
      description: Données pour créer ou mettre à jour une société
      required: [nom, tva]
      properties:
        nom:
          type: string
          maxLength: 255
          description: Nom de la société
          example: "WebElec SPRL"
        tva:
          type: string
          maxLength: 32
          description: Numéro de TVA (format belge recommandé)
          example: "BE0123456789"
        email:
          type: string
          format: email
          maxLength: 255
          description: Email de contact (doit être unique)
          example: "contact@webelec.be"
        telephone:
          type: string
          pattern: "^[0-9+().\\/\\-\\s]{6,30}$"
          description: Numéro de téléphone (6-30 caractères, chiffres et +()-./\s)
          example: "+32 2 123 45 67"
        adresse:
          type: string
          maxLength: 512
          description: Adresse postale complète
          example: "Rue de l'Électricité 42, 1000 Bruxelles"
    SocieteResponse:
      type: object
      description: Société retournée par l'API
      properties:
        id:
          type: integer
          format: int64
          description: Identifiant unique
          example: 1
        nom:
          type: string
          example: "WebElec SPRL"
        tva:
          type: string
          example: "BE0123456789"
        email:
          type: string
          example: "contact@webelec.be"
        telephone:
          type: string
          example: "+32 2 123 45 67"
        adresse:
          type: string
          example: "Rue de l'Électricité 42, 1000 Bruxelles"
    ChantierRequest:
      type: object
      required: [nom, societeId, clientId]
      properties:
        nom:
          type: string
          maxLength: 255
        adresse:
          type: string
        description:
          type: string
        societeId:
          type: integer
          format: int64
        clientId:
          type: integer
          format: int64
    ChantierResponse:
      allOf:
        - $ref: '#/components/schemas/ChantierRequest'
        - type: object
          properties:
            id:
              type: integer
              format: int64
    ClientRequest:
      type: object
      required: [nom, prenom, societeId]
      properties:
        nom:
          type: string
        prenom:
          type: string
        email:
          type: string
          format: email
        telephone:
          type: string
        adresse:
          type: string
        societeId:
          type: integer
          format: int64
    ClientResponse:
      allOf:
        - $ref: '#/components/schemas/ClientRequest'
        - type: object
          properties:
            id:
              type: integer
              format: int64
    ProduitRequest:
      type: object
      required: [reference, nom, quantiteStock, prixUnitaire, societeId]
      properties:
        reference:
          type: string
        nom:
          type: string
        description:
          type: string
        quantiteStock:
          type: integer
        prixUnitaire:
          type: number
          format: double
        societeId:
          type: integer
          format: int64
    ProduitResponse:
      allOf:
        - $ref: '#/components/schemas/ProduitRequest'
        - type: object
          properties:
            id:
              type: integer
              format: int64
    InterventionRequest:
      type: object
      required: [titre, dateIntervention, societeId, chantierId, clientId]
      properties:
        titre:
          type: string
        description:
          type: string
        dateIntervention:
          type: string
          format: date
        societeId:
          type: integer
          format: int64
        chantierId:
          type: integer
          format: int64
        clientId:
          type: integer
          format: int64
    InterventionResponse:
      allOf:
        - $ref: '#/components/schemas/InterventionRequest'
        - type: object
          properties:
            id:
              type: integer
              format: int64
    ProduitAvanceRequest:
      type: object
      required: [reference, nom, societeId]
      properties:
        reference:
          type: string
        nom:
          type: string
        description:
          type: string
        prixAchat:
          type: number
          format: double
        prixVente:
          type: number
          format: double
        fournisseur:
          type: string
        societeId:
          type: integer
          format: int64
    ProduitAvanceResponse:
      allOf:
        - $ref: '#/components/schemas/ProduitAvanceRequest'
        - type: object
          properties:
            id:
              type: integer
              format: int64
    DevisRequest:
      type: object
      required: [numero, dateEmission, dateExpiration, montantHT, montantTTC, statut, societeId, clientId, lignes]
      properties:
        numero:
          type: string
        dateEmission:
          type: string
          format: date
        dateExpiration:
          type: string
          format: date
        montantHT:
          type: number
          format: double
        montantTVA:
          type: number
          format: double
        montantTTC:
          type: number
          format: double
        statut:
          type: string
        societeId:
          type: integer
          format: int64
        clientId:
          type: integer
          format: int64
        lignes:
          type: array
          items:
            $ref: '#/components/schemas/DevisLigneRequest'
    DevisLigneRequest:
      type: object
      required: [description, quantite, prixUnitaire, total]
      properties:
        description:
          type: string
        quantite:
          type: integer
        prixUnitaire:
          type: number
          format: double
        total:
          type: number
          format: double
    DevisResponse:
      allOf:
        - $ref: '#/components/schemas/DevisRequest'
        - type: object
          properties:
            id:
              type: integer
              format: int64
    FactureRequest:
      type: object
      required: [numero, dateEmission, dateEcheance, montantHT, montantTVA, montantTTC, statut, societeId, clientId, lignes]
      properties:
        numero:
          type: string
        dateEmission:
          type: string
          format: date
        dateEcheance:
          type: string
          format: date
        montantHT:
          type: number
          format: double
        montantTVA:
          type: number
          format: double
        montantTTC:
          type: number
          format: double
        statut:
          type: string
        societeId:
          type: integer
          format: int64
        clientId:
          type: integer
          format: int64
        lignes:
          type: array
          items:
            $ref: '#/components/schemas/FactureLigneRequest'
    FactureLigneRequest:
      type: object
      required: [description, quantite, prixUnitaire, total]
      properties:
        description:
          type: string
        quantite:
          type: integer
        prixUnitaire:
          type: number
          format: double
        total:
          type: number
          format: double
    FactureResponse:
      allOf:
        - $ref: '#/components/schemas/FactureRequest'
        - type: object
          properties:
            id:
              type: integer
              format: int64
